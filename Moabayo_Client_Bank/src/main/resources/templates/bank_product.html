<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>모으냥즈 | 은행 상품 목록</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    :root {
      --cat-primary: #f4d06f;
      --cat-accent:  #ffe8a0;
      --cat-dark:    #1f1f28;
      --cat-light:   #fffdfa;
      --radius-xl:   1.25rem;
    }
    body { background: var(--cat-light); }
    .navbar-cat {
      background: linear-gradient(90deg, var(--cat-primary), var(--cat-accent));
      box-shadow: 0 6px 24px rgba(0,0,0,.08);
    }
    .navbar-brand{ font-weight: 800; color: var(--cat-dark); letter-spacing: .2px; }

    .filter-bar { background: #fff; border-radius: var(--radius-xl); padding: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,.06); border: 1px solid rgba(0,0,0,.06); }

    .product-card { border: 1px solid rgba(0,0,0,.08); border-radius: var(--radius-xl); overflow: hidden; background: #fff; transition: transform .12s ease, box-shadow .12s ease; }
    .product-card:hover { transform: translateY(-2px); box-shadow: 0 16px 32px rgba(0,0,0,.08); }

    .type-pill { display:inline-block; font-size:.8rem; padding:.25rem .6rem; border-radius:999px; background: var(--cat-accent); color:#5b4904; font-weight:700; }
    .img-wrap { background: linear-gradient(180deg, #fff, #faf7ef); }
    .img-wrap img { object-fit: contain; height: 140px; }

    .rate-badge { font-weight: 800; }
    .benefit-item { font-size: .92rem; }

    .empty-state { color: #8b8b8b; }

    /* Dark mode */
    .dark body{ background: #0f1115; }
    .dark .filter-bar, .dark .product-card { background: #121826; border-color: #1b2132; }
    .dark .navbar-cat { background: linear-gradient(90deg, #5b4e1f, #7c6c2a); }
    .dark .navbar-brand { color: #f0e8cf; }
    .dark .type-pill { background: #3a3321; color: #e7d99e; }
    .dark .empty-state { color: #a9a9a9; }
  </style>
</head>
<body>
  <!-- Top Nav -->
  <nav class="navbar navbar-cat navbar-expand-lg py-3">
    <div class="container">
      <a class="navbar-brand" href="#">🐾 모으냥즈 은행상품</a>
      <div class="ms-auto d-flex gap-2">
        <button id="toggleDark" class="btn btn-sm btn-light">다크모드</button>
        <a href="/" class="btn btn-sm btn-outline-dark">메인으로</a>
      </div>
    </div>
  </nav>

  <main class="container my-4">
    <!-- Filter Bar -->
    <section class="filter-bar mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-12 col-md-4">
          <label for="searchInput" class="form-label">검색 (이름/카테고리/타입)</label>
          <input id="searchInput" type="text" class="form-control" placeholder="예: Savings, Checking, Fixed" />
        </div>
        <div class="col-6 col-md-2">
          <label for="typeSelect" class="form-label">타입</label>
          <select id="typeSelect" class="form-select">
            <option value="">전체</option>
            <option value="Savings">Savings</option>
            <option value="Checking">Checking</option>
            <option value="Deposit">Deposit</option>
            <option value="Loan">Loan</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <label for="categorySelect" class="form-label">카테고리</label>
          <select id="categorySelect" class="form-select">
            <option value="">전체</option>
            <!-- 서버에서 distinct category 제공 시 치환 -->
            <option th:each="c : ${categories}" th:value="${c}" th:text="${c}">Savings</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <label for="sortSelect" class="form-label">정렬</label>
          <select id="sortSelect" class="form-select">
            <option value="default">기본</option>
            <option value="name-asc">이름 ↑</option>
            <option value="name-desc">이름 ↓</option>
            <option value="rate-asc">이율 ↑</option>
            <option value="rate-desc">이율 ↓</option>
          </select>
        </div>
        <div class="col-6 col-md-2 text-end">
          <button id="resetBtn" class="btn btn-outline-secondary w-100">초기화</button>
        </div>
      </div>
    </section>

    <!-- Grid -->
    <!-- 기대 모델: List<BankProduct> 를 products 로 전달
         BankProduct: { accountId, img, name, description, category, benefits(콤마), interest, type } -->
    <section>
      <div id="productGrid" class="row g-3 g-md-4">
        <div id="emptyState" class="col-12 text-center py-5 d-none">
          <h5 class="empty-state">조건에 맞는 은행 상품이 없어요 😿</h5>
        </div>

        <div class="col-12 col-sm-6 col-lg-4 col-xxl-3" th:each="p : ${products}"
             th:data-name="${p.name}" th:data-type="${p.type}" th:data-category="${p.category}"
             th:data-rate="${p.interest}">
          <article class="card product-card h-100">
            <div class="img-wrap d-flex align-items-center justify-content-center p-3">
              <img th:if="${p.img != null}" th:src="${p.img}" class="w-100" alt="상품 이미지"/>
              <img th:if="${p.img == null}" src="/images/account-placeholder.svg" class="w-50" alt="이미지 없음"/>
            </div>
            <div class="card-body d-flex flex-column gap-2">
              <div class="d-flex align-items-center justify-content-between">
                <span class="type-pill" th:text="${p.type}">Savings</span>
                <span class="rate-badge text-dark" th:text="${#numbers.formatDecimal(p.interest, 1, 'POINT', 2, 'NONE')} + '%'">1.20%</span>
              </div>
              <h5 class="card-title mb-1" th:text="${p.name}">Standard Savings</h5>
              <div class="text-muted small" th:text="${p.category}">Savings</div>
              <p class="card-text" th:text="${p.description}">기본 예금 상품 설명…</p>
              <ul class="list-unstyled mb-0">
                <li class="benefit-item" th:each="b : ${#strings.arraySplit(p.benefits, ',')}">
                  <i class="bi bi-check2-circle me-1"></i><span th:text="${#strings.trim(b)}">무이자 수수료</span>
                </li>
              </ul>
            </div>
            <div class="card-footer bg-transparent border-0 pb-3 px-3">
              <div class="d-flex gap-2">
                <a class="btn btn-dark flex-grow-1" th:href="@{'/bank/product/' + ${p.accountId}}">자세히</a>
                <button class="btn btn-outline-dark" type="button" onclick="addCompare(this)">비교</button>
              </div>
            </div>
          </article>
        </div>
      </div>
    </section>

    <!-- Compare Drawer -->
    <section id="compareBar" class="position-fixed bottom-0 start-0 end-0 translate-y-100" style="transition: transform .2s ease;">
      <div class="container">
        <div class="bg-dark text-white rounded-top-4 p-3 shadow-lg">
          <div class="d-flex justify-content-between align-items-center">
            <strong>비교함</strong>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-light" onclick="clearCompare()">비우기</button>
              <button class="btn btn-sm btn-light" onclick="openCompare()">비교하기</button>
            </div>
          </div>
          <div id="compareItems" class="d-flex gap-2 mt-2 flex-wrap"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Compare Modal -->
  <div class="modal fade" id="compareModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">은행 상품 비교</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>이름</th><th>타입</th><th>카테고리</th><th>이율</th>
                </tr>
              </thead>
              <tbody id="compareTableBody"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const grid = document.getElementById('productGrid');
    const searchInput = document.getElementById('searchInput');
    const typeSelect = document.getElementById('typeSelect');
    const categorySelect = document.getElementById('categorySelect');
    const sortSelect = document.getElementById('sortSelect');
    const resetBtn = document.getElementById('resetBtn');
    const emptyState = document.getElementById('emptyState');

    const normalize = s => (s||'').toString().toLowerCase();

    function applyFilters(){
      const q = normalize(searchInput.value);
      const t = normalize(typeSelect.value);
      const c = normalize(categorySelect.value);

      const items = [...grid.querySelectorAll('[data-name]')];
      let visible = 0;

      items.forEach(el => {
        const nm = normalize(el.dataset.name);
        const tp = normalize(el.dataset.type);
        const ct = normalize(el.dataset.category);

        const matchQ = !q || nm.includes(q) || tp.includes(q) || ct.includes(q);
        const matchT = !t || tp === t;
        const matchC = !c || ct === c;

        const show = matchQ && matchT && matchC;
        el.classList.toggle('d-none', !show);
        if(show) visible++;
      });

      emptyState.classList.toggle('d-none', visible !== 0);
      applySort();
    }

    function applySort(){
      const val = sortSelect.value;
      const parent = grid;
      const items = [...grid.querySelectorAll('[data-name]')].filter(el => !el.classList.contains('d-none'));
      const readName = el => (el.dataset.name||'').toLowerCase();
      const readRate = el => parseFloat(el.dataset.rate || '0');

      if(val === 'default') return;

      items.sort((a,b)=>{
        if(val === 'name-asc') return readName(a) > readName(b) ? 1 : -1;
        if(val === 'name-desc') return readName(a) < readName(b) ? 1 : -1;
        if(val === 'rate-asc') return readRate(a) - readRate(b);
        if(val === 'rate-desc') return readRate(b) - readRate(a);
        return 0;
      });
      items.forEach(el => parent.appendChild(el));
    }

    searchInput.addEventListener('input', applyFilters);
    typeSelect.addEventListener('change', applyFilters);
    categorySelect.addEventListener('change', applyFilters);
    sortSelect.addEventListener('change', applySort);
    resetBtn.addEventListener('click', () => {
      searchInput.value = '';
      typeSelect.value = '';
      categorySelect.value = '';
      sortSelect.value = 'default';
      applyFilters();
    });

    // Compare drawer logic
    const compareBar = document.getElementById('compareBar');
    const compareItems = document.getElementById('compareItems');
    const compareSet = new Map(); // key: name, value: meta

    window.addCompare = (btn) => {
      const root = btn.closest('[data-name]');
      const name = root.dataset.name;
      if(compareSet.has(name)) return;
      compareSet.set(name, {
        type: root.dataset.type,
        category: root.dataset.category,
        rate: root.dataset.rate
      });
      const chip = document.createElement('span');
      chip.className = 'badge rounded-pill text-bg-light border';
      chip.textContent = name;
      chip.dataset.key = name;
      chip.style.cursor = 'pointer';
      chip.onclick = () => { compareSet.delete(name); chip.remove(); toggleCompareBar(); };
      compareItems.appendChild(chip);
      toggleCompareBar();
    }

    function toggleCompareBar(){
      compareBar.style.transform = compareSet.size ? 'translateY(0)' : 'translateY(100%)';
    }
    window.clearCompare = () => { compareSet.clear(); compareItems.innerHTML = ''; toggleCompareBar(); }
    window.openCompare = () => {
      const tbody = document.getElementById('compareTableBody');
      tbody.innerHTML = '';
      [...compareSet.entries()].forEach(([name, v]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${name}</td><td>${v.type}</td><td>${v.category}</td><td>${v.rate}%</td>`;
        tbody.appendChild(tr);
      });
      const modal = new bootstrap.Modal(document.getElementById('compareModal'));
      modal.show();
    }

    // Dark mode toggle
    document.getElementById('toggleDark').addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
    });

    // 초기 적용
    applyFilters();
  </script>
</body>
</html>
