<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>보유계좌정보 | 모으냥즈</title>

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --cat-bg:#fff7e6;         /* 베이지/노랑 톤 */
      --cat-accent:#f7d774;     /* 포인트 */
      --cat-brown:#826a45;      /* 텍스트 강조 */
    }
    body{ background:var(--cat-bg); }
    .page-title{
      font-weight: 800;
      color: var(--cat-brown);
      letter-spacing:-0.3px;
    }
    .card-soft{
      border:0;
      border-radius:1rem;
      box-shadow: 0 6px 24px rgba(0,0,0,.06);
      background:#fff;
    }
    .chip{
      display:inline-flex; align-items:center; gap:.4rem;
      padding:.35rem .6rem; border-radius:999px; font-size:.85rem;
      background:#fff3cd; color:#7a5c20; border:1px dashed #f7d774;
    }
    .bank-logo{
      width:28px; height:28px; border-radius:50%; object-fit:cover;
      box-shadow:0 0 0 2px rgba(247,215,116,.45);
    }
    .table > :not(caption) > * > * { vertical-align: middle; }
    .btn-cat{
      background:var(--cat-accent); border:none; color:#3a2f16;
    }
    .btn-cat:hover{ filter: brightness(.95); color:#3a2f16; }
    .copy-badge{
      cursor:pointer; user-select:none;
    }
  </style>
</head>
<body>
  <!-- 헤더 영역 (있다면 include) -->
  <div id="header" th:replace="~{fragments/header :: header}"></div>

  <main class="container py-4 py-md-5">
    <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-4">
      <div>
        <h1 class="page-title mb-1">보유계좌정보</h1>
        <div class="text-secondary">내 모든 은행 계좌를 한 곳에서 확인하고 이체/관리하세요.</div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span class="chip"><i class="bi bi-shield-lock"></i> 개인정보 보호 모드</span>
        <button class="btn btn-sm btn-outline-secondary" id="toggleMaskBtn">
          <i class="bi bi-eye-slash"></i> 잔액 가리기
        </button>
      </div>
    </div>

    <!-- 요약 카드 -->
    <section class="row g-3 g-md-4 mb-4">
      <div class="col-12 col-md-4">
        <div class="card card-soft p-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-secondary">총 자산</span>
            <i class="bi bi-wallet2 fs-4 text-warning"></i>
          </div>
          <div class="fs-3 fw-bold" id="totalBalance" th:text="${#numbers.formatDecimal(summary.totalBalance, 0, 'COMMA', 0, 'POINT')}">45,320,000</div>
          <small class="text-secondary">전체 계좌 수 <span th:text="${summary.accountCount}">5</span>개</small>
        </div>
      </div>
      <div class="col-6 col-md-4">
        <div class="card card-soft p-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-secondary">입출금</span>
            <i class="bi bi-cash-coin fs-4 text-warning"></i>
          </div>
          <div class="fs-4 fw-semibold" th:text="${#numbers.formatDecimal(summary.depositBalance, 0, 'COMMA', 0, 'POINT')}">12,500,000</div>
          <small class="text-secondary">계좌 <span th:text="${summary.depositCount}">2</span>개</small>
        </div>
      </div>
      <div class="col-6 col-md-4">
        <div class="card card-soft p-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-secondary">적금/예금</span>
            <i class="bi bi-piggy-bank fs-4 text-warning"></i>
          </div>
          <div class="fs-4 fw-semibold" th:text="${#numbers.formatDecimal(summary.savingsBalance, 0, 'COMMA', 0, 'POINT')}">32,820,000</div>
          <small class="text-secondary">계좌 <span th:text="${summary.savingsCount}">3</span>개</small>
        </div>
      </div>
    </section>

    <!-- 필터/검색 -->
    <section class="card card-soft p-3 p-md-4 mb-4">
      <form class="row g-3 align-items-end" method="get" th:action="@{/accounts}">
        <div class="col-12 col-md-3">
          <label class="form-label">은행</label>
          <select class="form-select" name="bank">
            <option value="">전체</option>
            <option th:each="b : ${banks}" th:value="${b.code}" th:text="${b.name}">모으냥은행</option>
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">유형</label>
          <select class="form-select" name="type">
            <option value="">전체</option>
            <option value="DEMAND">입출금</option>
            <option value="SAVINGS">적금</option>
            <option value="TIME">정기예금</option>
            <option value="LOAN">대출</option>
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">상태</label>
          <select class="form-select" name="status">
            <option value="">전체</option>
            <option value="ACTIVE">정상</option>
            <option value="DORMANT">휴면</option>
            <option value="CLOSED">해지</option>
          </select>
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">검색</label>
          <div class="input-group">
            <input type="text" name="q" class="form-control" placeholder="계좌번호/별칭/상품명" th:value="${param.q}">
            <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
          </div>
        </div>
      </form>
    </section>

    <!-- 계좌 테이블 -->
    <section class="card card-soft p-2 p-md-3">
      <div class="table-responsive">
        <table class="table align-middle mb-0" id="accountTable">
          <thead class="table-light">
            <tr>
              <th style="width:36px;"></th>
              <th>은행 / 상품</th>
              <th>계좌번호</th>
              <th>별칭</th>
              <th class="text-end">잔액</th>
              <th>최근 거래</th>
              <th>상태</th>
              <th class="text-end">액션</th>
            </tr>
          </thead>
          <tbody>
            <!-- Thymeleaf 렌더링 -->
            <tr th:each="acc : ${accounts}"
                th:data-type="${acc.type}"
                th:data-status="${acc.status}">
              <td>
                <img class="bank-logo" th:src="${acc.bankLogoUrl}" alt="bank" />
              </td>
              <td>
                <div class="fw-semibold" th:text="${acc.bankName}">모으냥은행</div>
                <small class="text-secondary" th:text="${acc.productName}">모으냥 파워적금</small>
              </td>
              <td>
                <div class="d-flex align-items-center gap-2">
                  <span class="font-monospace" th:text="${acc.accountNumber}">123-4567-890123</span>
                  <span class="badge text-bg-light border copy-badge" onclick="copyText(this)" th:data-copy="${acc.accountNumber}">
                    <i class="bi bi-clipboard"></i> 복사
                  </span>
                </div>
              </td>
              <td th:text="${acc.nickname}">비상금통장</td>
              <td class="text-end balance-cell" th:text="${#numbers.formatDecimal(acc.balance, 0, 'COMMA', 0, 'POINT')}">3,210,000</td>
              <td>
                <span th:text="${#temporals.format(acc.lastTxnAt, 'yyyy.MM.dd')}">2025.08.10</span>
              </td>
              <td>
                <span th:classappend="${acc.status=='ACTIVE'} ? 'badge text-bg-success' :
                                      ${acc.status=='DORMANT'} ? 'badge text-bg-warning' :
                                      'badge text-bg-secondary'"
                      th:text="${acc.status}">ACTIVE</span>
              </td>
              <td class="text-end">
                <div class="btn-group">
                  <a class="btn btn-sm btn-outline-secondary" th:href="@{'/accounts/' + ${acc.id}}">
                    상세
                  </a>
                  <button class="btn btn-sm btn-cat" type="button" data-bs-toggle="modal"
                          data-bs-target="#transferModal"
                          th:attr="data-id=${acc.id},data-number=${acc.accountNumber},data-bank=${acc.bankName}">
                    이체
                  </button>
                </div>
              </td>
            </tr>

            <!-- (데모 데이터가 필요하면 서버 없을 때 아래 tr을 복제해서 테스트 가능) -->
          </tbody>
        </table>
      </div>

      <!-- 페이지네이션 -->
      <div class="d-flex justify-content-between align-items-center p-3">
        <small class="text-secondary">총 <span th:text="${page.totalElements}">12</span>건</small>
        <nav>
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item" th:classappend="${page.first} ? 'disabled'">
              <a class="page-link" th:href="@{/accounts(page=${page.number-1})}">이전</a>
            </li>
            <li class="page-item active">
              <span class="page-link" th:text="${page.number+1}">1</span>
            </li>
            <li class="page-item" th:classappend="${page.last} ? 'disabled'">
              <a class="page-link" th:href="@{/accounts(page=${page.number+1})}">다음</a>
            </li>
          </ul>
        </nav>
      </div>
    </section>
  </main>

  <!-- 이체 모달 -->
  <div class="modal fade" id="transferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" method="post" th:action="@{/transfer}">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-arrow-left-right"></i> 계좌 이체</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">출금계좌</label>
            <input class="form-control" id="fromAccount" name="fromAccount" readonly>
            <div class="form-text" id="fromBankHelp"></div>
          </div>
          <div class="mb-3">
            <label class="form-label">입금은행</label>
            <select class="form-select" name="toBankCode" required>
              <option th:each="b : ${banks}" th:value="${b.code}" th:text="${b.name}">모으냥은행</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">입금계좌번호</label>
            <input type="text" class="form-control" name="toAccountNumber" required placeholder="000-0000-000000">
          </div>
          <div class="mb-2">
            <label class="form-label">이체금액</label>
            <div class="input-group">
              <input type="number" class="form-control" name="amount" min="1" step="1" required>
              <span class="input-group-text">원</span>
            </div>
          </div>
          <div class="form-text text-secondary">수수료/한도는 은행 정책에 따릅니다.</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">취소</button>
          <button class="btn btn-cat" type="submit">이체하기</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 푸터 영역 (있다면 include) -->
  <div id="footer" th:replace="~{fragments/footer :: footer}"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 잔액 마스킹 토글
    const toggleMaskBtn = document.getElementById('toggleMaskBtn');
    let masked = false;
    toggleMaskBtn?.addEventListener('click', () => {
      masked = !masked;
      document.querySelectorAll('.balance-cell').forEach(td => {
        if(masked){
          td.dataset.actual = td.textContent;
          td.textContent = '••••••';
        } else {
          if(td.dataset.actual) td.textContent = td.dataset.actual;
        }
      });
      toggleMaskBtn.innerHTML = masked
        ? '<i class="bi bi-eye"></i> 잔액 보이기'
        : '<i class="bi bi-eye-slash"></i> 잔액 가리기';
    });

    // 계좌번호 복사
    function copyText(el){
      const text = el.getAttribute('data-copy') || el.dataset.copy;
      if(!text) return;
      navigator.clipboard.writeText(text).then(()=>{
        el.innerHTML = '<i class="bi bi-check2"></i> 복사됨';
        setTimeout(()=>{ el.innerHTML = '<i class="bi bi-clipboard"></i> 복사'; }, 1200);
      });
    }

    // 이체 모달 오픈 시 출금계좌 세팅
    const transferModal = document.getElementById('transferModal');
    transferModal?.addEventListener('show.bs.modal', (event) => {
      const btn = event.relatedTarget;
      const accNo = btn.getAttribute('data-number');
      const bank = btn.getAttribute('data-bank');
      document.getElementById('fromAccount').value = accNo || '';
      document.getElementById('fromBankHelp').textContent = bank ? ('출금은행: ' + bank) : '';
    });
  </script>
</body>
</html>
